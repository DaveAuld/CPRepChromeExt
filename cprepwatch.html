<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <title>CodeProject Reputation Watcher</title>
    <link type="text/css" href="css/custom-theme/jquery-ui-1.8.2.custom.css" rel="Stylesheet" />
    <script type="text/javascript" src="jquery/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="jquery/jquery-ui-1.8.2.custom.min.js"></script>
    <script type="text/javascript" src="js/cpjshelper.js"></script>
</head>
<script type="text/javascript">
    // -------------------------------------------------
    // Saves options to localStorage.
    // -------------------------------------------------
    function save_options() {

        //Get the current saved memberID
        var currentID = localStorage["memberID"];
        var newID = textMemberID.value;

        if (!(currentID == newID)) {
            //memberID has changed
            //Save the new memberID
            localStorage["memberID"] = newID;

            // Update status to let user know options were saved.
            if (localStorage["memberID"] == newID) {
                save_status.innerHTML = "MemberID: " + localStorage["memberID"] + " saved to local storage.";
                setTimeout(function () { save_status.innerHTML = ""; }, 1000);
                
                //Clear Saved Data
                var newRep = new Array();
                for (i = 0; i < 9; i++) {
                    newRep[i] = "0";              
                }

                //Update the stored Rep Data to 0 values
                setNewRepDetail(newRep);

                //Clear the table
                clearTable();

                //Reload the Page
                reload_Page();
            }
            else
            { save_status.innerHTML = "Error saving MemberID to localStorage."; }

        }
        else {
            save_status.innerHTML = "MemberID: has not changed.";
            setTimeout(function () { save_status.innerHTML = ""; }, 1000);
        }

    }

    // -------------------------------------------------
    // Clear the table of the Previous/Current and Change data
    // -------------------------------------------------
        function clearTable() {
        //Clear the table of existing Previous data
        $("#prevRepTotal").html("0");
        $("#prevRepAuthor").html("0");
        $("#prevRepAuthority").html("0");
        $("#prevRepDebator").html("0");
        $("#prevRepEditor").html("0");
        $("#prevRepEnquirer").html("0");
        $("#prevRepOrganiser").html("0");
        $("#prevRepParticipant").html("0");
        $("#prevRepDate").html("&nbsp;");

        //Clear the table of existing Current data
        $("#loadRepTotal").html("0");
        $("#loadRepAuthor").html("0");
        $("#loadRepAuthority").html("0");
        $("#loadRepDebator").html("0");
        $("#loadRepEditor").html("0");
        $("#loadRepEnquirer").html("0");
        $("#loadRepOrganiser").html("0");
        $("#loadRepParticipant").html("0");
        $("#loadRepDate").html("&nbsp;");

        //Clear the table of existing Change Data
        $("#repChange0").html("<img src='images/no_change.png' alt='No Change'>&nbsp;0");
        $("#repChange1").html("<img src='images/no_change.png' alt='No Change'>&nbsp;0");
        $("#repChange2").html("<img src='images/no_change.png' alt='No Change'>&nbsp;0");
        $("#repChange3").html("<img src='images/no_change.png' alt='No Change'>&nbsp;0");
        $("#repChange4").html("<img src='images/no_change.png' alt='No Change'>&nbsp;0");
        $("#repChange5").html("<img src='images/no_change.png' alt='No Change'>&nbsp;0");
        $("#repChange6").html("<img src='images/no_change.png' alt='No Change'>&nbsp;0");
        $("#repChange7").html("<img src='images/no_change.png' alt='No Change'>&nbsp;0");

        //Clear the Member Level Status
        //Total Rep (#repStatus0) has no status, doesn't change
        $("#repStatus0").html("&nbsp;");
        $("#repStatus1").html("&nbsp;");
        $("#repStatus2").html("&nbsp;");
        $("#repStatus3").html("&nbsp;");
        $("#repStatus4").html("&nbsp;");
        $("#repStatus5").html("&nbsp;");
        $("#repStatus6").html("&nbsp;");
        $("#repStatus7").html("&nbsp;");
        }

        // -------------------------------------------------
        // Restores memberId textbox state to saved value from localStorage.
        // -------------------------------------------------
    function restore_options() {
        var memberID = localStorage["memberID"];
        if (!memberID) {
            return;
        }
        var textbox = document.getElementById("textMemberID");
        textbox.value = memberID.toString();
    }

    // -------------------------------------------------
    // Button Save + Refresh + Navigates
    // -------------------------------------------------
    $(function () {
        $("button", ".save").button();
        $("button", ".buttons").button();
    });
    
    // -------------------------------------------------
    // Document has finished loading
    // -------------------------------------------------
    $(document).ready(function () {

        //load the page
        reload_Page();
    });

    // -------------------------------------------------
    // Refresh Page using the manual button
    // -------------------------------------------------

    function buttonPageRefresh() {
        //Google Analytics Event Tracker
        _gaq.push(['_trackEvent', 'ButtonRefreshPage', 'clicked']);

        //Commence Refresh
        reload_Page();
    }

    // -------------------------------------------------
    // Reload the page
    // -------------------------------------------------
    function reload_Page() {

        //Show the loading images
        $("#statusMessage").hide();
        $("#loadRepTable").show();

        setTimeout(function () {

            //Start loading the data from Codeproject profile
            $.get(getCPMemberProfile(), function (data) {

                setCPProfileData(data);

            });


        }, 1000);

        clearTable();
        getCPPage();     
    }

    // -------------------------------------------------
    // Get the Profile Page from CodeProject
    // -------------------------------------------------
    function getCPPage() {

        //Set Rep Page MemberID in Title
        $("#memberID").html(getMemberID());

        //Load the memberid from the localstorage
        restore_options();

        //Load the previous rep data from the localstorage
        var prevRep = getPrevRepDetail();
        if (!prevRep[0]) { prevRepTotal.innerHTML = "0"; } else { prevRepTotal.innerHTML = prevRep[0]; }
        if (!prevRep[1]) { prevRepAuthor.innerHTML = "0"; } else { prevRepAuthor.innerHTML = prevRep[1]; }
        if (!prevRep[2]) { prevRepAuthority.innerHTML = "0"; } else { prevRepAuthority.innerHTML = prevRep[2]; }
        if (!prevRep[3]) { prevRepDebator.innerHTML = "0"; } else { prevRepDebator.innerHTML = prevRep[3]; }
        if (!prevRep[4]) { prevRepEditor.innerHTML = "0"; } else { prevRepEditor.innerHTML = prevRep[4]; }
        if (!prevRep[5]) { prevRepEnquirer.innerHTML = "0"; } else { prevRepEnquirer.innerHTML = prevRep[5]; }
        if (!prevRep[6]) { prevRepOrganiser.innerHTML = "0"; } else { prevRepOrganiser.innerHTML = prevRep[6]; }
        if (!prevRep[7]) { prevRepParticipant.innerHTML = "0"; } else { prevRepParticipant.innerHTML = prevRep[7]; }
        if (!prevRep[8]) { prevRepDate.innerHTML = "0"; } else { prevRepDate.innerHTML = prevRep[8]; }
    }

    // -------------------------------------------------
    //  Parse the CodeProject Data
    // -------------------------------------------------
    function setCPProfileData(rawData) {

        //Need to load a copy of this, as we will overwrite original at end
        //and will need to pass to the calcRepChange function.
        var oldRep = new Array();
        oldRep = getPrevRepDetail();

        //Holding var to temp store until complete.
        var newRep = new Array();

        //Initialise the array; caters for Categories that have no data yet.
        for (i = 0; i < 9; i++)
        { newRep[i] = "0"; }

        //Clear the table of existing data
        $("#loadRepTotal").html("0");
        $("#loadRepAuthor").html("0");
        $("#loadRepAuthority").html("0");
        $("#loadRepDebator").html("0");
        $("#loadRepEditor").html("0");
        $("#loadRepEnquirer").html("0");
        $("#loadRepOrganiser").html("0");
        $("#loadRepParticipant").html("0");
        $("#loadRepDate").html("&nbsp;");
               
        //Get the raw data passed into the function and store in the holding div
        var raw = rawData;
        holdingdata.innerHTML = raw;

        var theNode = document.getElementById("About");
        if (theNode) {
            holdingdata.innerHTML = "";
            holdingdata.appendChild(theNode);
        }

        //The Total Reputation Member Level is Found in
        if ($("#ctl00_MC_Prof_TotalRepBox").hasClass("nostatus")) { $("#repStatus0").html("&nbsp;"); };
        if ($("#ctl00_MC_Prof_TotalRepBox").hasClass("bronze")) { $("#repStatus0").html("Bronze"); };
        if ($("#ctl00_MC_Prof_TotalRepBox").hasClass("silver")) { $("#repStatus0").html("Silver"); };
        if ($("#ctl00_MC_Prof_TotalRepBox").hasClass("gold")) { $("#repStatus0").html("Gold"); };
        if ($("#ctl00_MC_Prof_TotalRepBox").hasClass("platinum")) { $("#repStatus0").html("Platinum"); };

        //The Total Repution is found in this node
        var thestring = $("#ctl00_MC_Prof_TotalRep");
        if (thestring) { newRep[0] = thestring.text(); } else { newRep[0] = "0"; }

            $("#loadRepTotal").html(newRep[0]);

            //Version 1.5 Change
            //Now we need to locate the Member Rep Table, this has no ID now, but only a class name
            //We can grab the tag with the correct class name

            holdingdata.innerHTML = $('table.member-rep-list').html();

            $("#holdingdata").find("tr").each(function (iTR) {

                //console.log("Table Row: " + iTR);
                $(this).find("td").each(function (iTD) {

                    var MemberLevel = "";
                    //Version 1.1 4th August 2010, New CSS names
                    if ($(this).hasClass("nostatus")) { MemberLevel = "" };
                    if ($(this).hasClass("bronze")) { MemberLevel = "Bronze" };
                    if ($(this).hasClass("silver")) { MemberLevel = "Silver" };
                    if ($(this).hasClass("gold")) { MemberLevel = "Gold" };
                    if ($(this).hasClass("platinum")) { MemberLevel = "Platinum" };

                    var thevalue = $(this).find("div.medium-text").text();
                    if (!thevalue) { thevalue = ""; };

                    //Version 1.6 21st March 2011, Additional second link in each category
                    //iterate all the links determining a Category/Value pair

                    $(this).find("a").each( function (iA) {

                        var category = $(this).text();
                        if (!category) { category = "No Data"; };

                        category = category.toUpperCase(category);

                    switch (category) {
                        case ("AUTHOR"):
                            newRep[1] = thevalue;
                            $("#loadRepAuthor").html(newRep[1]);
                            $("#repStatus1").html(MemberLevel);
                            break;

                        case ("AUTHORITY"):
                            newRep[2] = thevalue;
                            $("#loadRepAuthority").html(newRep[2]);
                            $("#repStatus2").html(MemberLevel);
                            break;

                        case ("DEBATOR"):
                            newRep[3] = thevalue;
                            $("#loadRepDebator").html(newRep[3]);
                            $("#repStatus3").html(MemberLevel);
                            break;

                        case ("EDITOR"):
                            newRep[4] = thevalue;
                            $("#loadRepEditor").html(newRep[4]);
                            $("#repStatus4").html(MemberLevel);
                            break;

                        case ("ENQUIRER"):
                            newRep[5] = thevalue;
                            $("#loadRepEnquirer").html(newRep[5]);
                            $("#repStatus5").html(MemberLevel);
                            break;

                        case ("ORGANISER"):
                            newRep[6] = thevalue;
                            $("#loadRepOrganiser").html(newRep[6]);
                            $("#repStatus6").html(MemberLevel);
                            break;

                        case ("PARTICIPANT"):
                            newRep[7] = thevalue;
                            $("#loadRepParticipant").html(newRep[7]);
                            $("#repStatus7").html(MemberLevel);
                            break;
                        }
                    });
                });
            });

            //Set the Date here
            var theDate = new Date()
            newRep[8] = theDate.toDateString() + " , " + theDate.toLocaleTimeString();
            $("#loadRepDate").html(newRep[8]);

                //Calc the changes
                calcRepChange(oldRep, newRep);
            
            //hide the loading image and text
            $("#loadRepTable").hide();
            //dump the old holding data
            $("#holdingdata").html("");

            //Save to localStorage
            setNewRepDetail(newRep);
        }
    
</script>

<body bgcolor="#ffcc66">
    <script type="text/javascript" src="analytics.js"></script>
    <script type="text/javascript">
        //Initiate the JQUuery tabs
        $(function () {
            $("#tabs").tabs();
        });
    </script>
    <div style="width: 750px; font-size: small;">
    <center>
        <img alt="CodeProject Logo" src="images/codeproject468x60.gif" />
    </center>
        <div id="tabs" style="height: 400px;">
            <!-- Tab Pages -->
            <ul>
                <li><a href="#tabs-1">Reputation Points</a></li>
                <li><a href="repgraph.html">Reputation Graph</a></li>
                <li><a href="#tabs-3">Options</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
            <!-- Tab 1 Rep Points -->
            <div id="tabs-1" style="padding-left: 5px">
                <h3>
                    Reputation Points for MemberID: <span id="memberID"></span>
                </h3>
                    
                <table style="width: 735px; border: 2px double #FF9900">
                    <tr style="text-align: center">
                        <th>
                            Category
                        </th>
                        <th>
                            Previous
                        </th>
                        <th>
                            Current
                        </th>
                        <th>
                            Change
                        </th>
                        <th>
                            Status</th>
                    </tr>
                    <tr style="text-align: center">
                        <td>
                            Total Rep
                        </td>
                        <td id="prevRepTotal" class="style1">
                        </td>
                        <td>
                            <div id="loadRepTotal">
                                No Data</div>
                        </td>
                        <td id="repChange0">
                            &nbsp;
                        </td>
                        <td id="repStatus0">
                            &nbsp;</td>
                    </tr>
                    <tr style="text-align: center">
                        <td>
                            Author
                        </td>
                        <td id="prevRepAuthor">
                            &nbsp;
                        </td>
                        <td>
                            <div id="loadRepAuthor">
                                No Data</div>
                        </td>
                        <td id="repChange1">
                            &nbsp;
                        </td>
                        <td id="repStatus1">
                            &nbsp;</td>
                    </tr>
                    <tr style="text-align: center">
                        <td>
                            Authority
                        </td>
                        <td id="prevRepAuthority">
                            &nbsp;
                        </td>
                        <td>
                            <div id="loadRepAuthority">
                                No Data</div>
                        </td>
                        <td id="repChange2">
                            &nbsp;
                        </td>
                        <td id="repStatus2">
                            &nbsp;</td>
                    </tr>
                    <tr style="text-align: center">
                        <td>
                            Debator
                        </td>
                        <td id="prevRepDebator">
                            &nbsp;
                        </td>
                        <td>
                            <div id="loadRepDebator">
                                No Data</div>
                        </td>
                        <td id="repChange3">
                            &nbsp;
                        </td>
                        <td id="repStatus3">
                            &nbsp;</td>
                    </tr>
                    <tr style="text-align: center">
                        <td>
                            Editor
                        </td>
                        <td id="prevRepEditor">
                            &nbsp;
                        </td>
                        <td>
                            <div id="loadRepEditor">
                                No Data</div>
                        </td>
                        <td id="repChange4">
                            &nbsp;
                        </td>
                        <td id="repStatus4">
                            &nbsp;</td>
                    </tr>
                    <tr style="text-align: center">
                        <td>
                            Enquirer
                        </td>
                        <td id="prevRepEnquirer">
                            &nbsp;
                        </td>
                        <td>
                            <div id="loadRepEnquirer">
                                No Data</div>
                        </td>
                        <td id="repChange5">
                            &nbsp;
                        </td>
                        <td id="repStatus5">
                            &nbsp;</td>
                    </tr>
                    <tr style="text-align: center">
                        <td>
                            Organiser
                        </td>
                        <td id="prevRepOrganiser">
                            &nbsp;
                        </td>
                        <td>
                            <div id="loadRepOrganiser">
                                No Data</div>
                        </td>
                        <td id="repChange6">
                            &nbsp;
                        </td>
                        <td id="repStatus6">
                            &nbsp;</td>
                    </tr>
                    <tr style="text-align: center">
                        <td>
                            Participant
                        </td>
                        <td id="prevRepParticipant">
                            &nbsp;
                        </td>
                        <td>
                            <div id="loadRepParticipant">
                                No Data</div>
                        </td>
                        <td id="repChange7">
                            &nbsp;
                        </td>
                        <td id="repStatus7">
                            &nbsp;</td>
                    </tr>
                    <tr style="text-align: center">
                        <td>
                            Date Checked
                        </td>
                        <td id="prevRepDate">
                            &nbsp;
                        </td>
                        <td>
                            <div id="loadRepDate">
                                No Data</div>
                        </td>
                        <td>
                            &nbsp;
                        </td>
                        <td>
                            &nbsp;</td>
                    </tr>
                </table>
                <div>
                    <div class="buttons"><button title="Manually Refresh Data" onclick="buttonPageRefresh()">Refresh Data</button>
                    <button style="float:right" title="Detach Extension (Open the Extension in a window)" onclick="extDetach()">Detach Extension</button>
                    <button style="float:right" title="Open Members Profile on CodeProject (New Window)" onclick="navProfile()">Open Member Profile</button>
                    <button style="float:right" title="Open CodeProject (New Window)" onclick="navCodeProject()">Open CodeProject</button>
                    </div>

                    <div id="loadRepTable">
                        <h3>Loading Reputation Data.....<img alt="Loading Image" src="css/custom-theme/images/ui-anim_basic_16x16.gif" /></h3>
                    </div>
                    <div id="statusMessage"></div>
                </div>
            </div>
            <!-- Tab 2 Graph ; Note: This does not require a section as it is a link URL in tab definition above-->
            <!-- Tab 3 Options -->
            <div id="tabs-3" style="padding-left: 5px">
                <h3>
                    Enter the CodeProject MemberID:
                </h3>
                <input id="textMemberID" type="text" />
                <br />
                <br />
                <div class="save">
                    <button onclick="save_options()">
                        Save MemberID</button></div>
                <br />
                <div id="save_status" style="color: #FF0000">
                </div>
                <br />
            </div>
            <!-- Tab 4 About ; Note: This does not require a section as it is a link URL in tab definition above-->
        </div>
    </div>
    <!-- hidden Div used during the parsing process -->
    <div id="holdingdata" style="visibility: hidden; height: 0; width: 0; display: none;">
    </div>
</body>
</html>
